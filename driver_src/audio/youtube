#!/bin/bash

# 1. Configuration & Argument Handling
MODE="video"
QUERY="$1"

# Check if the first argument is "-a" for audio mode
if [ "$1" == "-a" ]; then
    MODE="audio"
    QUERY="$2"
fi

# Check if a search query exists
if [ -z "$QUERY" ]; then
    echo "Usage: ./youtube_music.sh [-a] 'search terms'"
    echo "Options: -a  Audio-only mode"
    exit 1
fi

echo "Searching ($MODE mode) for: $QUERY..."

# 2. Stability Options (Fixes the "First run works, second run hangs" issue)
# These flags are critical for postmarketOS on older tablets
YTDL_OPTS="-4 --no-cache-dir --extractor-args youtube:player_client=android"

# 3. Search and get Titles and IDs
# We use --print to extract metadata cleanly
results=$(yt-dlp $YTDL_OPTS "ytsearch5:$QUERY" --flat-playlist --print "%(title)s" --print "%(id)s")

# Check if we got results
if [ -z "$results" ]; then
    echo "No results found. Check your internet or try: yt-dlp --rm-cache-dir"
    exit 1
fi

# 4. Parse results into a list
mapfile -t lines <<< "$results"

echo "---------------------------------------"
count=0
for (( i=0; i<${#lines[@]}; i+=2 )); do
    title="${lines[$i]}"
    id="${lines[$((i+1))]}"
    
    if [ -n "$title" ]; then
        ((count++))
        echo "[$count] $title"
        ids[$count]=$id
    fi
done
echo "---------------------------------------"

# 5. User Selection
read -p "Select (1-$count) or 'q' to quit: " choice

if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -le "$count" ] && [ "$choice" -gt 0 ]; then
    selected_id=${ids[$choice]}
    url="https://www.youtube.com/watch?v=$selected_id"
    
    # 6. Playback Logic with modern mpv/ytdl hooks
    # --ytdl-raw-options passes our stability fixes into mpv's backend
    if [ "$MODE" == "audio" ]; then
        echo "Playing AUDIO ONLY..."
        mpv --vid=no --ytdl-format="bestaudio/best" \
            --ytdl-raw-options="force-ipv4=,no-cache-dir=,extractor-args=youtube:player_client=android" \
            "$url"
    else
        echo "Playing VIDEO (720p cap)..."
        mpv --ytdl-format="bestvideo[height<=720]+bestaudio/best" \
            --ytdl-raw-options="force-ipv4=,no-cache-dir=,extractor-args=youtube:player_client=android" \
            "$url"
    fi
else
    echo "Exiting."
    exit 0
fi
